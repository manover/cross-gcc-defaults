#!/usr/bin/make -f
# -*- makefile -*-

# Adjust these when we want to control which packages we release
RELEASE := 5
PKGS    := cpp gcc g++ gfortran gobjc gccgo

# this is there so that generate-pkgfiles.pl can ask about it
say_progs_release:
	@echo $(PKGS) $(RELEASE)
.PHONY: say_progs_release

# version suffix used when we need further uploads without a new gcc
# upload. Normally not set. Used as: SUFFIX=.1 dpkg-buildpackage
# Or can be set here (remember to comment it out again for next upload)
# SUFFIX ?= .1


#export DH_VERBOSE=1
%:
	dh $@

override_dh_auto_build:
	grep Package: debian/control | cut -d ' ' -f 2 | xargs -I{} cp debian/lintian-overrides debian/{}.lintian-overrides

override_dh_auto_configure:
override_dh_auto_test:

override_dh_installchangelogs:
	dh_installchangelogs
	find debian -name changelog \! -wholename debian/changelog | xargs -I{} mv {} {}.Debian


# I get the arches based on what's in my debian/control file
ARCHES_GNU_TYPE = \
  $(shell perl -ne \
    'if(/Package: *[a-z0-9+_-]+-([a-z0-9+_-]+-[a-z0-9+_-]+-[a-z0-9+_-]+)/) {print "$$1\n";}' \
    < debian/control | uniq)

override_dh_auto_install:
	for arch in $(ARCHES_GNU_TYPE); do							\
	    while read pkg prog ver; do								\
	        dh_link -p$$pkg-$$arch usr/bin/$$arch-$$prog-$$ver usr/bin/$$arch-$$prog;	\
            done < debian/defaults;								\
	done

override_dh_clean:
	dh_clean
	rm -f debian/*.lintian-overrides


# each package package-arch is Depends: package-arch-release (>=version)
# where 'version' is the current version of gcc-release-base (+suffix
# if needed to distinguish)
#
# asking for the first line only because I can have multiple arches installed at
# the same time, and I only want a single version.
GCC_BINARY_VERSION := \
 $(or $(shell dpkg-query -f '$${Version}\n' -W gcc-$(RELEASE)-base | head -n1), \
   $(error gcc-$(RELEASE)-base must be installed))
override_dh_gencontrol:
	dh_gencontrol -- -v$(GCC_BINARY_VERSION)$(SUFFIX) -Vver=$(GCC_BINARY_VERSION)

control:
	debian/generate-pkgfiles.pl

.PHONY: control
